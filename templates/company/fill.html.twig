{# templates/company/fill.html.twig #}
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dossier de Convention - Finalisation</title>

    {# Importation de vos assets sp√©cifiques (importmap) #}
    {% block stylesheets %}
        {{ importmap('app') }}
    {% endblock %}

    {# Lien vers Font Awesome #}
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    {# --- VOS STYLES PERSONNALIS√âS --- #}
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #005c97 0%, #363795 100%);
            --header-bg: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            --accent-color: #0d6efd;
            --success-color: #198754;
        }

        body {
            background-color: #f0f2f5;
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #444;
            padding-bottom: 80px; /* Espace pour le footer */
        }

        .main-container {
            background: rgba(255, 255, 255, 0.99);
            border-radius: 20px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.08);
            margin: -3rem auto 2rem; /* Remonte sur le header */
            padding: 2.5rem;
            position: relative;
            z-index: 10;
        }

        /* En-t√™te */
        .header-bg {
            background: var(--header-bg);
            padding: 4rem 0 6rem;
            color: white;
            text-align: center;
        }

        .user-badge {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(5px);
            color: white;
            padding: 0.5rem 1.2rem;
            border-radius: 30px;
            font-weight: 500;
            border: 1px solid rgba(255,255,255,0.2);
            font-size: 0.95rem;
        }

        /* Cartes Sections */
        .section-card {
            background: white;
            border-radius: 16px;
            border: 1px solid #edf2f7;
            box-shadow: 0 2px 8px rgba(0,0,0,0.02);
            margin-bottom: 2rem;
            overflow: hidden;
        }

        .section-header {
            background: #f8fafc;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #edf2f7;
            display: flex;
            align-items: center;
        }

        .section-header h4 {
            margin: 0;
            font-weight: 700;
            color: #2d3748;
            font-size: 1.05rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .section-header i {
            color: var(--accent-color);
            background: rgba(13, 110, 253, 0.1);
            width: 32px; height: 32px;
            display: flex; align-items: center; justify-content: center;
            border-radius: 8px;
            font-size: 0.9rem;
        }

        .section-body { padding: 1.5rem; }

        /* Champs Formulaire */
        .form-label { font-weight: 600; color: #4a5568; font-size: 0.85rem; margin-bottom: 0.4rem; }

        .form-control, .form-select {
            border-radius: 8px; border: 1px solid #cbd5e0; padding: 0.6rem 0.8rem; font-size: 0.95rem;
        }

        /* Style sp√©cifique pour s'assurer que le placeholder est bien gris */
        .form-control::placeholder {
            color: #a0aec0;
            opacity: 1; /* Firefox */
        }

        .form-control:focus { border-color: var(--accent-color); box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.1); }
        .form-control.bg-light { background-color: #f8fafc; }

        /* Switch Boxes - Logistique */
        .logistics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .switch-box {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            padding: 0.8rem 1rem;
            display: flex; align-items: center; justify-content: space-between;
            cursor: pointer;
            transition: all 0.2s;
        }
        .switch-box:hover { border-color: var(--accent-color); background: #f8faff; }

        .form-check-input { width: 2.5em; height: 1.3em; cursor: pointer; margin-top: 0; flex-shrink: 0; }
        .form-check-input:checked { background-color: var(--accent-color); border-color: var(--accent-color); }

        /* Bloc Gratification */
        .bonus-section {
            background-color: #fffdf0;
            border: 1px solid #ffeeba;
            border-radius: 12px;
            padding: 1.2rem;
            margin-top: 1rem;
        }
        .bonus-header { display: flex; align-items: center; justify-content: space-between; }
        .bonus-amount-reveal {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px dashed #e6dbb9;
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }

        /* Tableau Horaires */
        .schedule-table-wrapper { border-radius: 10px; overflow: hidden; border: 1px solid #e2e8f0; }
        #schedule-table thead { background: #f1f5f9; }
        #schedule-table th { font-weight: 600; color: #4a5568; padding: 0.8rem; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.5px; }
        .day-cell { background-color: #f8fafc; font-weight: 700; color: #3182ce; text-transform: uppercase; font-size: 0.75rem; vertical-align: middle; }
        .js-time-input { text-align: center; font-weight: 500; font-family: monospace; }

        /* Placeholder pour les horaires aussi */
        .js-time-input::placeholder { color: #cbd5e0; font-weight: 300; }

        .table .form-control-sm { padding: 0.25rem 0.5rem; }


        #week-total { color: var(--success-color); font-weight: 800; font-size: 1.2rem; }

        /* Bouton Valider */
        .btn-validate {
            background: var(--success-color); border: none; border-radius: 50px;
            padding: 1rem 3rem; font-weight: 700; font-size: 1.1rem; color: white;
            box-shadow: 0 4px 15px rgba(25, 135, 84, 0.3); transition: all 0.2s;
            display: inline-flex; align-items: center; gap: 0.5rem;
        }
        .btn-validate:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(25, 135, 84, 0.4); background-color: #157347; color: white; }

        /* Helpers */
        .icon-label { width: 24px; text-align: center; display: inline-block; margin-right: 8px; opacity: 0.7; }
        .text-section-title { font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; font-weight: 700; color: #a0aec0; margin-bottom: 1rem; }

        @media (max-width: 768px) { .main-container { padding: 1.5rem; margin-top: -4rem; } }
    </style>
</head>
<body>

{# --- HEADER --- #}
<div class="header-bg">
    <div class="container">
        <h1 class="display-6 fw-bold mb-2">Finalisation de la Convention</h1>
        <div>
                <span class="user-badge">
                    <i class="fas fa-user-graduate me-2"></i>
                    Dossier de {{ contract.student.firstname }} {{ contract.student.lastname|upper }}
                </span>
        </div>
    </div>
</div>

<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-11 col-xl-10">

            {# FORMULAIRE PRINCIPAL #}
            <div class="main-container">
                {{ form_start(form, {'attr': {'class': 'needs-validation', 'id': 'convention-form', 'novalidate': 'novalidate'}}) }}

                <div class="row g-4">

                    {# --- GAUCHE : ADMINISTRATIF --- #}
                    <div class="col-lg-6">
                        <div class="section-card h-100">
                            <div class="section-header">
                                <h4><i class="fas fa-building"></i> Informations Administratives</h4>
                            </div>
                            <div class="section-body">

                                {# ENTREPRISE #}
                                <div class="mb-4">
                                    <div class="text-section-title">üè¢ L'Entreprise</div>
                                    <div class="mb-3">
                                        {{ form_row(form.organisation.name, {
                                            'label': 'Raison Sociale',
                                            'attr': {'placeholder': 'Ex: Tech Solutions', 'class': 'form-control'}
                                        }) }}
                                    </div>
                                    <div class="row g-2">
                                        <div class="col-12">{{ form_row(form.organisation.addressHq, {'attr': {'placeholder': 'Ex: 12 avenue des Lilas', 'class': 'form-control'}}) }}</div>
                                        <div class="col-4">{{ form_row(form.organisation.postalCodeHq, {'attr': {'placeholder': 'CP', 'class': 'form-control'}}) }}</div>
                                        <div class="col-8">{{ form_row(form.organisation.cityHq, {'attr': {'placeholder': 'Ville', 'class': 'form-control'}}) }}</div>
                                    </div>
                                </div>

                                {# RESPONSABLE #}
                                <div class="mb-4 pt-3 border-top">
                                    <div class="text-section-title">üñãÔ∏è Responsable Signataire</div>
                                    <div class="row g-2">
                                        <div class="col-6">{{ form_row(form.organisation.respName, {'label': 'Nom', 'attr': {'placeholder': 'Ex: Martin Paul', 'class': 'form-control'}}) }}</div>
                                        <div class="col-6">{{ form_row(form.organisation.respFunction, {'label': 'Fonction', 'attr': {'class': 'form-control', 'placeholder': 'Ex: G√©rant, DRH...'}}) }}</div>
                                    </div>
                                    <div class="mb-2 mt-2">
                                        {{ form_row(form.organisation.respEmail, {'label': 'Email', 'attr': {'class': 'form-control', 'placeholder': 'Ex: responsable@entreprise.com'}}) }}
                                    </div>
                                    {# T√©l√©phones Signataire #}
                                    <div class="row g-2">
                                        <div class="col-12">
                                            {# Note : J'ai retir√© le faux champ "Mobile" car votre base de donn√©es ne le g√®re pas encore #}
                                            {{ form_row(form.organisation.respPhone, {'label': 'T√©l√©phone', 'attr': {'class': 'form-control', 'placeholder': 'Ex: 01 23 45 67 89'}}) }}
                                        </div>
                                    </div>
                                </div>

                                {# ASSURANCE #}
                                <div class="pt-3 border-top">
                                    <div class="text-section-title">üõ°Ô∏è Assurance</div>
                                    <div class="row g-2">
                                        {{ form_row(form.organisation.insuranceName, {'label': 'Assureur', 'attr': {'class': 'form-control', 'placeholder': 'Ex: AXA, Allianz...'}}) }}
                                        <div class="col-6">{{ form_row(form.organisation.insuranceContract, {'label': 'N¬∞ Police', 'attr': {'class': 'form-control', 'placeholder': 'N¬∞ Contrat'}}) }}</div>
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>

                    {# --- DROITE : TUTEUR & STAGE --- #}
                    <div class="col-lg-6">

                        {# TUTEUR #}
                        <div class="section-card">
                            <div class="section-header">
                                <h4><i class="fas fa-chalkboard-teacher"></i> Le Ma√Ætre de Stage</h4>
                            </div>
                            <div class="section-body">
                                <div class="row g-2 mb-3">
                                    <div class="col-6">{{ form_row(form.tutor.lastname, {'label': 'Nom', 'attr': {'class': 'form-control', 'placeholder': 'Ex: Dupont'}}) }}</div>
                                    <div class="col-6">{{ form_row(form.tutor.firstname, {'label': 'Pr√©nom', 'attr': {'class': 'form-control', 'placeholder': 'Ex: Jean'}}) }}</div>
                                </div>
                                <div class="mb-3">
                                    {{ form_row(form.tutor.email, {'label': 'Email Direct', 'attr': {'class': 'form-control', 'placeholder': 'Ex: tuteur@entreprise.com'}}) }}
                                </div>
                                <div class="row g-2">
                                    <div class="col-6">
                                        {{ form_row(form.tutor.telMobile, {'label': 'T√©l. Portable', 'attr': {'class': 'form-control', 'placeholder': 'Ex: 06 12 34 56 78'}}) }}
                                    </div>
                                    <div class="col-6">
                                        {# Correction : Utilisation du vrai champ telOther au lieu du champ bloqu√© #}
                                        {{ form_row(form.tutor.telOther, {
                                            'label': 'T√©l. Fixe (Option)',
                                            'attr': {'class': 'form-control', 'placeholder': 'Ex: 01 23 45 67 89'}
                                        }) }}
                                    </div>
                                </div>
                            </div>
                        </div>

                        {# LE STAGE #}
                        <div class="section-card">
                            <div class="section-header">
                                <h4><i class="fas fa-briefcase"></i> D√©tails du Stage</h4>
                            </div>
                            <div class="section-body">
                                <div class="mb-3">
                                    {{ form_label(form.plannedActivities, null, {'label_attr': {'class': 'form-label fw-bold'}}) }}
                                    {{ form_widget(form.plannedActivities, {'attr': {'class': 'form-control', 'rows': 4, 'placeholder': 'Ex: D√©crivez ici les missions principales qui seront confi√©es au stagiaire...'}}) }}
                                    {{ form_errors(form.plannedActivities) }}
                                </div>

                                {# GRATIFICATION #}
                                <div class="bonus-section" data-controller="bonus-toggle">
                                    <div class="bonus-header">
                                        <div>
                                            <label class="form-check-label fw-bold text-dark" for="{{ form.bonus.vars.id }}">
                                                <i class="fas fa-euro-sign text-warning me-2"></i> Gratification
                                            </label>
                                            <div class="small text-muted">Une prime est-elle pr√©vue ?</div>
                                        </div>
                                        {{ form_widget(form.bonus, {
                                            'attr': {
                                                'class': 'form-check-input',
                                                'data-bonus-toggle-target': 'checkbox',
                                                'data-action': 'change->bonus-toggle#toggle'
                                            }
                                        }) }}
                                    </div>

                                    <div data-bonus-toggle-target="amountContainer"
                                         class="bonus-amount-reveal"
                                         id="bonusAmountContainer"
                                         style="display: none;">

                                        <label class="form-label small fw-bold mt-2" for="{{ form.bonusAmount.vars.id }}">Montant et modalit√©s de versement (obligatoire si oui)</label>
                                        {{ form_widget(form.bonusAmount, {'attr': {
                                            'class': 'form-control',
                                            'placeholder': 'Ex: 600‚Ç¨ net mensuel par virement...',
                                            'data-bonus-toggle-target': 'amountInput'
                                        }}) }}
                                        {{ form_errors(form.bonusAmount) }}
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>

                {# --- LOGISTIQUE (GRANDE LARGEUR) --- #}
                <div class="section-card mt-2">
                    <div class="section-header">
                        <h4><i class="fas fa-cogs"></i> Logistique</h4>
                    </div>
                    <div class="section-body">
                        <div class="logistics-grid">
                            <div class="switch-box">
                                <label class="form-check-label fw-semibold" for="{{ form.deplacement.vars.id }}">
                                    <span class="icon-label">üöó</span> D√©placements
                                </label>
                                {{ form_widget(form.deplacement, {'attr': {'class': 'form-check-input'}}) }}
                            </div>
                            <div class="switch-box">
                                <label class="form-check-label fw-semibold" for="{{ form.transportFreeTaken.vars.id }}">
                                    <span class="icon-label">üöå</span> Transport
                                </label>
                                {{ form_widget(form.transportFreeTaken, {'attr': {'class': 'form-check-input'}}) }}
                            </div>
                            <div class="switch-box">
                                <label class="form-check-label fw-semibold" for="{{ form.lunchTaken.vars.id }}">
                                    <span class="icon-label">üçΩÔ∏è</span> Repas
                                </label>
                                {{ form_widget(form.lunchTaken, {'attr': {'class': 'form-check-input'}}) }}
                            </div>
                            <div class="switch-box">
                                <label class="form-check-label fw-semibold" for="{{ form.hostTaken.vars.id }}">
                                    <span class="icon-label">üè†</span> H√©bergement
                                </label>
                                {{ form_widget(form.hostTaken, {'attr': {'class': 'form-check-input'}}) }}
                            </div>
                        </div>
                    </div>
                </div>

                {# --- HORAIRES (GRANDE LARGEUR) --- #}
                <div class="section-card">
                    <div class="section-header justify-content-between">
                        <h4><i class="far fa-clock"></i> Emploi du temps</h4>
                        <span class="badge bg-primary">Hebdomadaire</span>
                    </div>
                    <div class="section-body p-0">
                        <div class="table-responsive schedule-table-wrapper border-0">
                            <table class="table table-bordered text-center align-middle mb-0" id="schedule-table">
                                <thead>
                                <tr>
                                    <th rowspan="2" style="width: 10%;">JOUR</th>
                                    <th colspan="2">Matin</th>
                                    <th colspan="2">Apr√®s-midi</th>
                                    <th rowspan="2" style="width: 12%;">Total</th>
                                </tr>
                                <tr>
                                    <th>D√©but</th><th>Fin</th><th>D√©but</th><th>Fin</th>
                                </tr>
                                </thead>
                                <tbody>
                                {% for day, dayForm in form.workHours %}
                                    <tr class="schedule-row">
                                        <td class="day-cell">{{ day|capitalize }}</td>
                                        {# Ajout de placeholder '--:--' pour les horaires #}
                                        <td class="p-1">{{ form_widget(dayForm.m_start, {'attr': {'class': 'form-control form-control-sm text-center js-time-input', 'placeholder': '--:--'}}) }}</td>
                                        <td class="p-1">{{ form_widget(dayForm.m_end, {'attr': {'class': 'form-control form-control-sm text-center js-time-input', 'placeholder': '--:--'}}) }}</td>
                                        <td class="p-1">{{ form_widget(dayForm.am_start, {'attr': {'class': 'form-control form-control-sm text-center js-time-input', 'placeholder': '--:--'}}) }}</td>
                                        <td class="p-1">{{ form_widget(dayForm.am_end, {'attr': {'class': 'form-control form-control-sm text-center js-time-input', 'placeholder': '--:--'}}) }}</td>
                                        <td class="fw-bold day-total bg-light" style="color: var(--accent-color);">0h</td>
                                    </tr>
                                {% endfor %}
                                </tbody>
                                <tfoot class="table-light">
                                <tr>
                                    <td colspan="5" class="text-end fw-bold pe-4">Total Semaine :</td>
                                    <td class="fw-bold" id="week-total">0h</td>
                                </tr>
                                </tfoot>
                            </table>
                        </div>
                        <div id="alert-35h" class="alert alert-warning m-3 d-none shadow-sm border-warning small">
                            <i class="fas fa-exclamation-triangle me-2"></i> <strong>Attention :</strong> Le total hebdomadaire est inf√©rieur √† 35 heures.
                        </div>
                    </div>
                </div>

                {# --- INFORMATIONS COMPL√âMENTAIRES --- #}
                <div class="section-card mt-4">
                    <div class="section-header">
                        <h4><i class="fas fa-info-circle"></i> Informations Compl√©mentaires</h4>
                    </div>
                    <div class="section-body">

                        {# Site Web #}
                        <div class="mb-3">
                            {{ form_row(form.organisation.website, {
                                'label': 'Site Web',
                                'attr': {'placeholder': 'Ex: https://www.exemple.com', 'class': 'form-control'}
                            }) }}
                        </div>

                        {# Adresse du stage #}
                        <div class="mb-3">
                            {{ form_row(form.organisation.addressInternship, {
                                'label': 'Adresse du stage (si diff√©rente)',
                                'attr': {'placeholder': 'Ex: 12 rue de l\'Industrie...', 'class': 'form-control'}
                            }) }}
                            <small class="form-text text-muted">√Ä compl√©ter si l'adresse est diff√©rente du si√®ge social.</small>
                        </div>

                        <div class="row g-3">
                            {# Code Postal #}
                            <div class="col-md-4 mb-3">
                                {{ form_row(form.organisation.postalCodeInternship, {
                                    'label': 'Code Postal',
                                    'attr': {'placeholder': 'Ex: 75000', 'class': 'form-control'}
                                }) }}
                            </div>
                            {# Ville #}
                            <div class="col-md-8 mb-3">
                                {{ form_row(form.organisation.cityInternship, {
                                    'label': 'Ville',
                                    'attr': {'placeholder': 'Ex: Paris', 'class': 'form-control'}
                                }) }}
                            </div>
                        </div>

                        {# Ici, j'ai supprim√© le doublon de telOther qui se trouvait ici #}

                    </div>
                </div>

                {# --- ACTIONS --- #}
                <div class="text-center mt-5">
                    <button type="submit" class="btn-validate">
                        Valider le dossier <i class="fas fa-paper-plane ms-2"></i>
                    </button>
                    <p class="text-muted mt-3 small">
                        En validant, je certifie l'exactitude des informations saisies.
                    </p>
                </div>

                {{ form_end(form) }}
            </div>

            <div class="text-center mt-3 mb-5 text-muted small">
                &copy; {{ "now"|date("Y") }} Lyc√©e Gabriel Faur√© - Espace Entreprise
            </div>

        </div>
    </div>
</div>

{# --- SCRIPT JS --- #}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- 1. Gestion Affichage Gratification ---
        const bonusCheckbox = document.getElementById('{{ form.bonus.vars.id }}');
        const bonusContainer = document.getElementById('bonusAmountContainer');
        const bonusAmountInput = document.getElementById('{{ form.bonusAmount.vars.id }}');

        function toggleBonus() {
            if (bonusCheckbox && bonusContainer) {
                if (bonusCheckbox.checked) {
                    bonusContainer.style.display = 'block';
                } else {
                    bonusContainer.style.display = 'none';
                    if(bonusAmountInput) {
                        // On ne vide pas la valeur ici si on veut garder la donn√©e en cas d'erreur
                        // bonusAmountInput.value = '';
                    }
                }
            }
        }

        if(bonusCheckbox) {
            bonusCheckbox.addEventListener('change', toggleBonus);
            const hasExistingValue = bonusAmountInput && bonusAmountInput.value.length > 0;
            if (bonusCheckbox.checked || hasExistingValue) {
                bonusContainer.style.display = 'block';
            } else {
                bonusContainer.style.display = 'none';
            }
            toggleBonus();
        }

        // --- 2. Calcul des Heures ---
        const rows = document.querySelectorAll('.schedule-row');
        const weekTotalDisplay = document.getElementById('week-total');
        const alert35h = document.getElementById('alert-35h');

        function calculateTimeDiff(start, end) {
            if (!start || !end) return 0;
            const [startH, startM] = start.split(':').map(Number);
            const [endH, endM] = end.split(':').map(Number);
            if (isNaN(startH) || isNaN(endH)) return 0;

            let diff = (endH * 60 + endM) - (startH * 60 + startM);
            return diff > 0 ? diff : 0;
        }

        function formatHours(minutes) {
            const h = Math.floor(minutes / 60);
            const m = minutes % 60;
            const mStr = m < 10 ? '0' + m : m;
            return m > 0 ? `${h}h${mStr}` : `${h}h`;
        }

        function updateTotals() {
            let weekTotal = 0;
            rows.forEach(row => {
                const inputs = row.querySelectorAll('.js-time-input');
                if (inputs.length === 4) {
                    const am = calculateTimeDiff(inputs[0].value, inputs[1].value);
                    const pm = calculateTimeDiff(inputs[2].value, inputs[3].value);
                    const dayTotal = am + pm;
                    weekTotal += dayTotal;

                    const dayDisplay = row.querySelector('.day-total');
                    if(dayDisplay) dayDisplay.textContent = dayTotal > 0 ? formatHours(dayTotal) : '-';
                }
            });

            if (weekTotalDisplay) weekTotalDisplay.textContent = formatHours(weekTotal);

            if (alert35h) {
                if (weekTotal > 0 && weekTotal < 2100) {
                    alert35h.classList.remove('d-none');
                } else {
                    alert35h.classList.add('d-none');
                }
            }
        }

        document.querySelectorAll('.js-time-input').forEach(input => {
            input.addEventListener('input', updateTotals);
            input.addEventListener('change', updateTotals);
        });

        updateTotals();
    });
</script>

</body>
</html>
