{# templates/convention/finalization.html.twig #}

<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dossier de Convention - Finalisation</title>

    {% block stylesheets %}
        {# Ceci est l'appel √† ton fichier assets/styles/app.css via importmap #}
        {{ importmap('app') }}
    {% endblock %}

    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    {# NOTE: Les styles CSS internes ont √©t√© d√©plac√©s dans assets/styles/app.css #}
</head>
<body>

{# --- S√âLECTEUR DE LANGUE --- #}
<div class="language-selector">
    <select class="form-select form-select-sm" aria-label="S√©lection de la langue" style="min-width: 120px;">
        <option selected>üá´üá∑ Fran√ßais</option>
        <option value="en">üá¨üáß English</option>
        <option value="es">üá™üá∏ Espa√±ol</option>
        <option value="it">üáÆüáπ Italiano</option>
        <option value="de">üá©üá™ Deutsch</option>
    </select>
</div>

{# --- HEADER --- #}
<div class="header-bg">
    <div class="container">
        <h1 class="display-6 fw-bold mb-2">Finalisation de la Convention</h1>
        <div>
                <span class="user-badge">
                    <i class="fas fa-user-graduate me-2"></i>
                    Dossier de {{ contract.student.firstname }} {{ contract.student.lastname|upper }}
                </span>
        </div>
    </div>
</div>

<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-11 col-xl-10">

            {# FORMULAIRE #}
            <div class="main-container">
                {{ form_start(form, {'attr': {'class': 'needs-validation', 'id': 'convention-form', 'novalidate': 'novalidate'}}) }}

                <div class="row g-4">

                    {# --- GAUCHE : ADMINISTRATIF --- #}
                    <div class="col-lg-6">
                        <div class="section-card h-100">
                            <div class="section-header">
                                <h4><i class="fas fa-building"></i> Informations Administratives</h4>
                            </div>
                            <div class="section-body">

                                {# ENTREPRISE #}
                                <div class="mb-4">
                                    <div class="text-section-title">üè¢ L'Entreprise</div>
                                    {# Nom de l'organisme * #}
                                    <div class="mb-3">
                                        {{ form_row(form.organisation.name, {'label': 'Raison Sociale', 'attr': {'placeholder': 'Ex: Tech Solutions', 'required': 'required'}, 'label_attr': {'class': 'required'}}) }}
                                    </div>
                                    {# SIRET * #}
                                    <div class="mb-3">
                                        {# J'utilise un champ visuel si 'siret' n'est pas mapp√© dans le form, sinon le champ r√©el #}
                                        {% if form.organisation.siret is defined %}
                                            {{ form_row(form.organisation.siret, {'label': 'N¬∞ SIRET', 'attr': {'placeholder': 'Ex: 12345678900000', 'required': 'required'}, 'label_attr': {'class': 'required'}}) }}
                                        {% else %}
                                            <label class="form-label required">N¬∞ SIRET</label>
                                            <input type="text" class="form-control" name="organisation_siret_visual" placeholder="Ex: 12345678900000" required>
                                        {% endif %}
                                    </div>

                                    <div class="text-section-title mt-4">üìç Adresse du Si√®ge</div>
                                    {# Adresse * #}
                                    <div class="col-12 mb-2">
                                        {{ form_row(form.organisation.addressHq, {'label': 'Adresse compl√®te', 'attr': {'placeholder': 'N¬∞ et Rue', 'required': 'required'}, 'label_attr': {'class': 'required'}}) }}
                                    </div>
                                    {# Compl√©ment d'adresse #}
                                    <div class="col-12 mb-2">
                                        {# Si le champ existe dans le form, l'utiliser. Sinon un champ visuel #}
                                        {% if form.organisation.addressComplementHq is defined %}
                                            {{ form_row(form.organisation.addressComplementHq, {'label': 'Compl√©ment d\'adresse', 'attr': {'placeholder': 'B√¢timent, √©tage, etc.'}}) }}
                                        {% else %}
                                            <label class="form-label">Compl√©ment d'adresse (Optionnel)</label>
                                            <input type="text" class="form-control" name="organisation_addressComplementHq_visual" placeholder="B√¢timent, √©tage, etc.">
                                        {% endif %}
                                    </div>
                                    <div class="row g-2 mb-2">
                                        {# Code postal * #}
                                        <div class="col-4">
                                            {{ form_row(form.organisation.postalCodeHq, {'label': 'Code postal', 'attr': {'placeholder': 'CP', 'required': 'required'}, 'label_attr': {'class': 'required'}}) }}
                                        </div>
                                        {# Ville * #}
                                        <div class="col-8">
                                            {{ form_row(form.organisation.cityHq, {'label': 'Ville', 'attr': {'placeholder': 'Ville', 'required': 'required'}, 'label_attr': {'class': 'required'}}) }}
                                        </div>
                                    </div>
                                    {# Pays * #}
                                    <div class="col-12">
                                        {% if form.organisation.countryHq is defined %}
                                            {{ form_row(form.organisation.countryHq, {'label': 'Pays', 'attr': {'required': 'required'}, 'label_attr': {'class': 'required'}}) }}
                                        {% else %}
                                            <label class="form-label required">Pays</label>
                                            <input type="text" class="form-control" name="organisation_countryHq_visual" placeholder="Ex: France" value="France" required>
                                        {% endif %}
                                    </div>
                                </div>

                                {# RESPONSABLE SIGNATAIRE #}
                                <div class="mb-4 pt-3 border-top">
                                    <div class="text-section-title">üñãÔ∏è Responsable Signataire</div>
                                    <div class="row g-2">
                                        {# Nom du responsable de l'entreprise * #}
                                        <div class="col-6">
                                            {{ form_row(form.organisation.respName, {'label': 'Nom', 'attr': {'placeholder': 'Nom', 'required': 'required'}, 'label_attr': {'class': 'required'}}) }}
                                        </div>
                                        {# Pr√©nom du responsable * #}
                                        {% if form.organisation.respFirstname is defined %}
                                            <div class="col-6">
                                                {{ form_row(form.organisation.respFirstname, {'label': 'Pr√©nom', 'attr': {'placeholder': 'Pr√©nom', 'required': 'required'}, 'label_attr': {'class': 'required'}}) }}
                                            </div>
                                        {% else %}
                                            <div class="col-6">
                                                <label class="form-label required">Pr√©nom</label>
                                                <input type="text" class="form-control" name="organisation_respFirstname_visual" placeholder="Pr√©nom" required>
                                            </div>
                                        {% endif %}
                                    </div>
                                    {# Fonction du responsable * #}
                                    <div class="mb-3 mt-2">
                                        {{ form_row(form.organisation.respFunction, {'label': 'Fonction', 'attr': {'required': 'required'}, 'label_attr': {'class': 'required'}}) }}
                                    </div>
                                    {# Email * (Attention: signataire de la convention) #}
                                    <div class="mb-2">
                                        {{ form_row(form.organisation.respEmail, {'label': 'Email (Signataire)', 'attr': {'required': 'required'}, 'label_attr': {'class': 'required'}}) }}
                                        <small class="text-muted fst-italic">Cet email recevra la convention pour signature.</small>
                                    </div>
                                    {# T√©l√©phones : au moins un des 2 obligatoires #}
                                    <div class="row g-2" id="resp-phone-group">
                                        {# T√©l√©phone fixe #}
                                        <div class="col-6">
                                            {{ form_row(form.organisation.respPhone, {'label': 'T√©l. Fixe'}) }}
                                        </div>
                                        {# T√©l√©phone portable #}
                                        <div class="col-6">
                                            {% if form.organisation.respMobile is defined %}
                                                {{ form_row(form.organisation.respMobile, {'label': 'T√©l. Portable'}) }}
                                            {% else %}
                                                <label class="form-label">T√©l. Portable</label>
                                                <input type="tel" class="form-control" name="organisation_respMobile_visual" placeholder="06 / 07...">
                                            {% endif %}
                                        </div>
                                        <div class="col-12">
                                            <small class="text-danger small fst-italic" id="phone-alert" style="display:none;">‚ö†Ô∏è **Attention :** Le t√©l√©phone fixe ou portable est obligatoire.</small>
                                        </div>
                                    </div>

                                    {# Site Web #}
                                    <div class="mt-3">
                                        {% if form.organisation.website is defined %}
                                            {{ form_row(form.organisation.website, {'label': 'Site Web (Optionnel)', 'attr': {'placeholder': 'https://...'}}) }}
                                        {% else %}
                                            <label class="form-label">Site Web (Optionnel)</label>
                                            <input type="url" class="form-control" name="organisation_website_visual" placeholder="https://...">
                                        {% endif %}
                                    </div>
                                </div>

                                {# ASSURANCE #}
                                <div class="pt-3 border-top">
                                    <div class="text-section-title">üõ°Ô∏è Assurance Responsabilit√© Civile</div>
                                    <div class="row g-2">
                                        {# Nom de l'assureur * #}
                                        <div class="col-6">
                                            {{ form_row(form.organisation.insuranceName, {'label': 'Assureur', 'attr': {'required': 'required'}, 'label_attr': {'class': 'required'}}) }}
                                        </div>
                                        {# R√©f√©rence contrat assureur * #}
                                        <div class="col-6">
                                            {{ form_row(form.organisation.insuranceContract, {'label': 'N¬∞ Police / Contrat', 'attr': {'required': 'required'}, 'label_attr': {'class': 'required'}}) }}
                                        </div>
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>

                    {# --- DROITE : TUTEUR & STAGE --- #}
                    <div class="col-lg-6">

                        {# TUTEUR #}
                        <div class="section-card">
                            <div class="section-header">
                                <h4><i class="fas fa-chalkboard-teacher"></i> Le Ma√Ætre de Stage</h4>
                            </div>
                            <div class="section-body">
                                <div class="row g-2 mb-3">
                                    <div class="col-6">
                                        {{ form_row(form.tutor.lastname, {'label': 'Nom', 'attr': {'required': 'required'}, 'label_attr': {'class': 'required'}}) }}
                                    </div>
                                    <div class="col-6">
                                        {{ form_row(form.tutor.firstname, {'label': 'Pr√©nom', 'attr': {'required': 'required'}, 'label_attr': {'class': 'required'}}) }}
                                    </div>
                                </div>
                                <div class="mb-3">
                                    {{ form_row(form.tutor.email, {'label': 'Email Direct', 'attr': {'required': 'required'}, 'label_attr': {'class': 'required'}}) }}
                                </div>
                                <div class="row g-2">
                                    <div class="col-6">
                                        {{ form_row(form.tutor.telMobile, {'label': 'T√©l. Portable (Recommand√©)'}) }}
                                    </div>
                                    <div class="col-6">
                                        <label class="form-label">T√©l. Fixe (Option)</label>
                                        <input type="text" class="form-control bg-light" placeholder="01..." readonly style="cursor: not-allowed;" title="Champ non modifiable">
                                    </div>
                                </div>
                            </div>
                        </div>

                        {# LE STAGE #}
                        <div class="section-card">
                            <div class="section-header">
                                <h4><i class="fas fa-briefcase"></i> D√©tails du Stage</h4>
                            </div>
                            <div class="section-body">
                                <div class="mb-3">
                                    {# Description des Activit√©s / Missions * #}
                                    {{ form_label(form.plannedActivities, 'Description des Activit√©s / Missions', {'label_attr': {'class': 'form-label required'}}) }}
                                    {{ form_widget(form.plannedActivities, {'attr': {'class': 'form-control', 'rows': 4, 'placeholder': 'D√©crivez les missions d√©taill√©es, les objectifs du stage...', 'required': 'required'}}) }}
                                </div>

                                <div class="bonus-section">
                                    <div class="bonus-header">
                                        <div>
                                            <label class="form-check-label fw-bold text-dark" for="bonus-checkbox">
                                                <i class="fas fa-euro-sign text-warning me-2"></i> Gratification
                                            </label>
                                            <div class="small text-muted">Une prime est-elle pr√©vue ? (Obligatoire si stage > 2 mois)</div>
                                        </div>
                                        {{ form_widget(form.bonus, {'attr': {'class': 'form-check-input', 'id': 'bonus-checkbox'}}) }}
                                    </div>

                                    {# Zone qui appara√Æt quand on coche #}
                                    <div id="bonus-amount-container" class="bonus-amount-reveal" style="display: none;">
                                        <label class="form-label small fw-bold required">Montant et modalit√©s de versement *</label>
                                        <input type="text" name="bonus_details_visual" class="form-control" placeholder="Ex: 600‚Ç¨ net mensuel par virement...">
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>

                {# --- LOGISTIQUE (GRANDE LARGEUR) --- #}
                <div class="section-card mt-2">
                    <div class="section-header">
                        <h4><i class="fas fa-cogs"></i> Logistique et Prise en Charge</h4>
                    </div>
                    <div class="section-body">
                        <div class="logistics-grid">
                            <div class="switch-box">
                                <label class="form-check-label fw-semibold" for="{{ form.deplacement.vars.id }}">
                                    <span class="icon-label">üöó</span> Frais de D√©placements pris en charge
                                </label>
                                {{ form_widget(form.deplacement, {'attr': {'class': 'form-check-input'}}) }}
                            </div>
                            <div class="switch-box">
                                <label class="form-check-label fw-semibold" for="{{ form.transportFreeTaken.vars.id }}">
                                    <span class="icon-label">üöå</span> Transport (Pass/Abonnement) pris en charge
                                </label>
                                {{ form_widget(form.transportFreeTaken, {'attr': {'class': 'form-check-input'}}) }}
                            </div>
                            <div class="switch-box">
                                <label class="form-check-label fw-semibold" for="{{ form.lunchTaken.vars.id }}">
                                    <span class="icon-label">üçΩÔ∏è</span> Repas (Tickets Resto / Cantine)
                                </label>
                                {{ form_widget(form.lunchTaken, {'attr': {'class': 'form-check-input'}}) }}
                            </div>
                            <div class="switch-box">
                                <label class="form-check-label fw-semibold" for="{{ form.hostTaken.vars.id }}">
                                    <span class="icon-label">üè†</span> Frais d'H√©bergement pris en charge
                                </label>
                                {{ form_widget(form.hostTaken, {'attr': {'class': 'form-check-input'}}) }}
                            </div>
                        </div>
                    </div>
                </div>

                {# --- HORAIRES (GRANDE LARGEUR) - INTACT COMME DEMAND√â #}
                <div class="section-card">
                    <div class="section-header justify-content-between">
                        <h4><i class="far fa-clock"></i> Emploi du temps</h4>
                        <span class="badge bg-primary">Hebdomadaire</span>
                    </div>
                    <div class="section-body p-0">
                        <div class="table-responsive schedule-table-wrapper border-0">
                            <table class="table table-bordered text-center align-middle mb-0" id="schedule-table">
                                <thead>
                                <tr>
                                    <th rowspan="2" style="width: 10%;">JOUR</th>
                                    <th colspan="2">Matin</th>
                                    <th colspan="2">Apr√®s-midi</th>
                                    <th rowspan="2" style="width: 12%;">Total</th>
                                </tr>
                                <tr>
                                    <th>D√©but</th><th>Fin</th><th>D√©but</th><th>Fin</th>
                                </tr>
                                </thead>
                                <tbody>
                                {% for day, dayForm in form.workHours %}
                                    <tr class="schedule-row">
                                        <td class="day-cell">{{ day|capitalize }}</td>
                                        <td class="p-1">{{ form_widget(dayForm.m_start, {'attr': {'class': 'form-control form-control-sm text-center js-time-input', 'pattern': '\\d{2}:\\d{2}'}}) }}</td>
                                        <td class="p-1">{{ form_widget(dayForm.m_end, {'attr': {'class': 'form-control form-control-sm text-center js-time-input', 'pattern': '\\d{2}:\\d{2}'}}) }}</td>
                                        <td class="p-1">{{ form_widget(dayForm.am_start, {'attr': {'class': 'form-control form-control-sm text-center js-time-input', 'pattern': '\\d{2}:\\d{2}'}}) }}</td>
                                        <td class="p-1">{{ form_widget(dayForm.am_end, {'attr': {'class': 'form-control form-control-sm text-center js-time-input', 'pattern': '\\d{2}:\\d{2}'}}) }}</td>
                                        <td class="fw-bold day-total bg-light" style="color: var(--accent-color);">0h</td>
                                    </tr>
                                {% endfor %}
                                </tbody>
                                <tfoot class="table-light">
                                <tr>
                                    <td colspan="5" class="text-end fw-bold pe-4">Total Semaine :</td>
                                    <td class="fw-bold" id="week-total">0h</td>
                                </tr>
                                </tfoot>
                            </table>
                        </div>
                        <div id="alert-35h" class="alert alert-warning m-3 d-none shadow-sm border-warning small">
                            <i class="fas fa-exclamation-triangle me-2"></i> <strong>Attention :</strong> Le total hebdomadaire est inf√©rieur √† 35 heures.
                        </div>
                        {% do form.workHours.setRendered() %}
                    </div>
                </div>

                {# ACTIONS #}
                <div class="text-center mt-5">
                    <button type="submit" class="btn-validate">
                        Valider le dossier <i class="fas fa-paper-plane ms-2"></i>
                    </button>
                    <p class="text-muted mt-3 small">
                        En validant, je certifie l'exactitude des informations saisies. Les champs marqu√©s d'une <strong class="text-danger">*</strong> sont obligatoires.
                    </p>
                </div>

                {{ form_end(form) }}
            </div>

            <div class="text-center mt-4 text-muted small">
                &copy; {{ "now"|date("Y") }} Lyc√©e Gabriel Faur√© - Espace Entreprise
            </div>

        </div>
    </div>
</div>

{# --- SCRIPT JS --- #}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- 1. Gestion Affichage Gratification ---
        const bonusCheckbox = document.getElementById('bonus-checkbox');
        const bonusContainer = document.getElementById('bonus-amount-container');
        const bonusAmountInput = bonusContainer ? bonusContainer.querySelector('input[name="bonus_details_visual"]') : null;

        function toggleBonus() {
            if (bonusCheckbox && bonusContainer) {
                if (bonusCheckbox.checked) {
                    bonusContainer.style.display = 'block';
                    if (bonusAmountInput) bonusAmountInput.setAttribute('required', 'required');
                } else {
                    bonusContainer.style.display = 'none';
                    if (bonusAmountInput) {
                        bonusAmountInput.removeAttribute('required');
                        bonusAmountInput.value = ''; // Vider le champ si on d√©coche
                    }
                }
            }
        }

        if(bonusCheckbox) {
            bonusCheckbox.addEventListener('change', toggleBonus);
            // √âtat initial au chargement de la page
            toggleBonus();
        }

        // --- 2. Validation d'au moins un t√©l√©phone (Fixe ou Portable) pour le Responsable ---
        const formElement = document.getElementById('convention-form');
        const respPhoneInput = document.getElementById('{{ form.organisation.respPhone.vars.id }}');

        // G√©rer le champ mobile soit via le form, soit le champ visuel
        const respMobileInput = document.getElementById('{{ form.organisation.respMobile.vars.id }}') || document.querySelector('input[name="organisation_respMobile_visual"]');

        const phoneAlert = document.getElementById('phone-alert');

        function validatePhones() {
            const phoneFixedValue = respPhoneInput ? respPhoneInput.value.trim() : '';
            const phoneMobileValue = respMobileInput ? respMobileInput.value.trim() : '';

            const isOnePhoneFilled = phoneFixedValue || phoneMobileValue;

            if (phoneAlert) {
                if (!isOnePhoneFilled) {
                    phoneAlert.style.display = 'block';
                    // Emp√™cher la soumission si l'alerte est l√†
                    respPhoneInput.setCustomValidity('Au moins un num√©ro de t√©l√©phone est requis.');
                    if(respMobileInput) respMobileInput.setCustomValidity('Au moins un num√©ro de t√©l√©phone est requis.');
                } else {
                    phoneAlert.style.display = 'none';
                    respPhoneInput.setCustomValidity(''); // R√©initialiser pour permettre la soumission
                    if(respMobileInput) respMobileInput.setCustomValidity('');
                }
            }
            return isOnePhoneFilled;
        }

        // Ajout des √©couteurs pour la validation dynamique
        if (respPhoneInput) respPhoneInput.addEventListener('input', validatePhones);
        if (respMobileInput) respMobileInput.addEventListener('input', validatePhones);


        // --- 3. Calcul des Heures (Intact) ---
        const rows = document.querySelectorAll('.schedule-row');
        const weekTotalDisplay = document.getElementById('week-total');
        const alert35h = document.getElementById('alert-35h');

        function calculateTimeDiff(start, end) {
            if (!start || !end) return 0;
            const [startH, startM] = start.split(':').map(Number);
            const [endH, endM] = end.split(':').map(Number);
            if (isNaN(startH) || isNaN(endH)) return 0;

            let diff = (endH * 60 + endM) - (startH * 60 + startM);
            return diff > 0 ? diff : 0;
        }

        function formatHours(minutes) {
            const h = Math.floor(minutes / 60);
            const m = minutes % 60;
            const mStr = m < 10 ? '0' + m : m;
            return m > 0 ? `${h}h${mStr}` : `${h}h`;
        }

        function updateTotals() {
            let weekTotal = 0;
            rows.forEach(row => {
                const inputs = row.querySelectorAll('.js-time-input');
                if (inputs.length === 4) {
                    const am = calculateTimeDiff(inputs[0].value, inputs[1].value);
                    const pm = calculateTimeDiff(inputs[2].value, inputs[3].value);
                    const dayTotal = am + pm;
                    weekTotal += dayTotal;

                    const dayDisplay = row.querySelector('.day-total');
                    if(dayDisplay) dayDisplay.textContent = dayTotal > 0 ? formatHours(dayTotal) : '-';
                }
            });

            if (weekTotalDisplay) weekTotalDisplay.textContent = formatHours(weekTotal);

            if (alert35h) {
                if (weekTotal > 0 && weekTotal < 35 * 60) {
                    alert35h.classList.remove('d-none');
                } else {
                    alert35h.classList.add('d-none');
                }
            }
        }

        document.querySelectorAll('.js-time-input').forEach(input => {
            input.addEventListener('input', updateTotals);
            input.addEventListener('change', updateTotals);
        });

        // Calculs initiaux
        updateTotals();
        validatePhones(); // V√©rification initiale du t√©l√©phone

        // --- 4. Validation finale avant soumission ---
        formElement.addEventListener('submit', function(event) {
            if (!validatePhones() || !formElement.checkValidity()) {
                event.preventDefault();
                event.stopPropagation();
            }
            formElement.classList.add('was-validated');
        }, false);
    });
</script>

</body>
</html>
